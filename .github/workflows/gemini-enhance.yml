name: Gemini AI Reviewer Workflow

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  gemini_code_review:
    name: Run Gemini AI Code Review
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      actions: read
      checks: write
      id-token: write

    env:
      GEMINI_MODEL: gemini-2.5-pro-exp-03-25
      INPUT_EXCLUDE: |
        **/node_modules
        **/dist
        **/build
        **/coverage
        **/*.log
        **/*.tmp
        .github/**
      CACHE_VERSION: 1
      GEMINI_CACHE_PATH: ${{ github.workspace }}/.cache/gemini

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Gemini cache directory
        run: mkdir -p ${{ env.GEMINI_CACHE_PATH }}

      - name: Set Up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'
          cache: 'npm'
          cache-key: "npm-${{ env.CACHE_VERSION }}"

      - name: Install Dependencies
        if: steps.setup-node.outputs.cache-hit != 'true'
        run: npm ci
        env:
          npm_config_cache: ${{ env.GEMINI_CACHE_PATH }}/npm

      - name: Run Gemini AI Reviewer
        id: gemini_review
        uses: HoangNguyen0403/gemini-ai-code-reviewer@v1.0.0
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ env.GEMINI_MODEL }}
          INPUT_EXCLUDE: ${{ env.INPUT_EXCLUDE }}
          EXCLUDE: ${{ env.INPUT_EXCLUDE }}
          WORKING_DIRECTORY: ${{ github.workspace }}
          FAIL_ON_ERROR: true
          REVIEW_THRESHOLD: MEDIUM

      - name: Handle Gemini Review Output
        if: success()
        run: |
          echo "‚ú® Gemini AI Review completed successfully"
          echo "üìä Review Statistics:"
          echo "üîç Files analyzed: ${{ steps.gemini_review.outputs.files_analyzed }}"
          echo "üìù Suggestions provided: ${{ steps.gemini_review.outputs.suggestions_count }}"

      - name: Log Failure
        if: failure()
        run: |
          echo "‚ùå Gemini AI Review failed"
          echo "üìã Error details:"
          cat ${{ github.workspace }}/gemini-error.log

      - name: Upload Logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: gemini-review-logs
          path: ${{ github.workspace }}/gemini-error.log

      - name: Upload Gemini Cache
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: gemini-cache
          path: ${{ env.GEMINI_CACHE_PATH }}
